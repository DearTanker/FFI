const fs = require('fs');
const { execSync } = require('child_process');
const path = require('path');

function formatBeijingIso(date) {
  // date is a JS Date in UTC
  // convert to Beijing (UTC+8)
  const beijing = new Date(date.getTime() + 8 * 60 * 60 * 1000);
  const Y = beijing.getUTCFullYear();
  const M = String(beijing.getUTCMonth() + 1).padStart(2, '0');
  const D = String(beijing.getUTCDate()).padStart(2, '0');
  const hh = String(beijing.getUTCHours()).padStart(2, '0');
  const mm = String(beijing.getUTCMinutes()).padStart(2, '0');
  return `${Y}.${M}.${D}.${hh}${mm}`;
}

function getGitCommitDateIso() {
  try {
    // %cI gives ISO 8601 strict format of committer date
    const out = execSync('git log -1 --format=%cI', { encoding: 'utf8' }).trim();
    if (out) return new Date(out);
  } catch (e) {
    // ignore
  }
  return null;
}

function main() {
  const outPath = path.join(__dirname, '..', 'src', 'lib', 'buildInfo.ts');

  let date = null;
  // Prefer explicit env var if set (e.g., CI can set GIT_COMMIT_DATE)
  if (process.env.GIT_COMMIT_DATE) {
    date = new Date(process.env.GIT_COMMIT_DATE);
  }
  if (!date) date = getGitCommitDateIso();
  if (!date) date = new Date();

  const version = formatBeijingIso(date);

  const content = `// Generated by scripts/generate-build-info.js
export const BUILD_VERSION = ${JSON.stringify(version)} as const;
`;

  fs.mkdirSync(path.dirname(outPath), { recursive: true });
  fs.writeFileSync(outPath, content, 'utf8');
  console.log('Generated buildInfo.ts ->', outPath, 'BUILD_VERSION=', version);
}

main();
